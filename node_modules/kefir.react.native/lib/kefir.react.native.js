"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.fromIds = exports.fromClasses = exports.fromClass = exports.fromKefir = exports.config = undefined;

var _slicedToArray = function () { function sliceIterator(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"]) _i["return"](); } finally { if (_d) throw _e; } } return _arr; } return function (arr, i) { if (Array.isArray(arr)) { return arr; } else if (Symbol.iterator in Object(arr)) { return sliceIterator(arr, i); } else { throw new TypeError("Invalid attempt to destructure non-iterable instance"); } }; }();

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

var _ramda = require("ramda");

var R = _interopRequireWildcard(_ramda);

var _react = require("react");

var _react2 = _interopRequireDefault(_react);

var _kefir = require("kefir");

var _combine = require("./combine");

var Combine = _interopRequireWildcard(_combine);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

//

var config = exports.config = {
  onError: function onError(e) {
    throw e;
  }
};

//

var common = {
  componentWillReceiveProps: function componentWillReceiveProps(nextProps) {
    this.doUnsubscribe();
    this.doSubscribe(nextProps);
  },
  componentWillMount: function componentWillMount() {
    this.doUnsubscribe();
    this.doSubscribe(this.props);
  },
  shouldComponentUpdate: function shouldComponentUpdate(np, ns) {
    return ns.rendered !== this.state.rendered;
  },
  componentWillUnmount: function componentWillUnmount() {
    this.doUnsubscribe();
    this.setState(this.getInitialState());
  },
  render: function render() {
    return this.state.rendered;
  }
};

//

var FromKefirEnd = { callback: null };
var FromKefirNull = { callback: null, rendered: null };

var FromKefir = _react2.default.createClass(_extends({}, common, {
  getInitialState: function getInitialState() {
    return FromKefirNull;
  },
  doUnsubscribe: function doUnsubscribe() {
    var callback = this.state.callback;

    if (callback) this.props.observable.offAny(callback);
  },
  doSubscribe: function doSubscribe(_ref) {
    var _this = this;

    var observable = _ref.observable;

    if (observable instanceof _kefir.Observable) {
      var callback = function callback(e) {
        switch (e.type) {
          case "value":
            _this.setState({ rendered: e.value });
            break;
          case "error":
            config.onError(e.value);
            break;
          case "end":
            _this.setState(FromKefirEnd);
            break;
        }
      };
      observable.onAny(callback);
      this.setState({ callback: callback });
    } else {
      this.setState({ rendered: observable });
    }
  }
}));

var fromKefir = exports.fromKefir = function fromKefir(observable) {
  return _react2.default.createElement(FromKefir, { observable: observable });
};

//

function forEach(props, fn) {
  for (var key in props) {
    var val = props[key];
    if (val instanceof _kefir.Observable) {
      fn(val);
    } else if ("children" === key && val instanceof Array) {
      for (var i = 0, n = val.length; i < n; ++i) {
        var valI = val[i];
        if (valI instanceof _kefir.Observable) fn(valI);
      }
    }
  }
}

function render(Class, props, values) {
  var newProps = {};
  var newChildren = void 0;

  var k = -1;

  for (var key in props) {
    var val = props[key];
    if (val instanceof _kefir.Observable) {
      var valO = values[++k];
      if ("children" === key) newChildren = valO;else if ("mount" === key) newProps.ref = valO;else newProps[key] = valO;
    } else if ("children" === key) {
      if (val instanceof Array) {
        for (var i = 0, n = val.length; i < n; ++i) {
          var valI = val[i];
          if (valI instanceof _kefir.Observable) {
            if (!newChildren) {
              newChildren = Array(val.length);
              for (var j = 0; j < i; ++j) {
                newChildren[j] = val[j];
              }
            }
            newChildren[i] = values[++k];
          } else if (newChildren) {
            newChildren[i] = val[i];
          }
        }
      }
      if (!newChildren) newChildren = val;
    } else if ("mount" === key) {
      newProps.ref = val;
    } else {
      newProps[key] = val;
    }
  }

  return _react2.default.createElement(Class, newProps, newChildren || null);
}

//

function FakeComponent(state, props) {
  this.props = props;
  this.state = state;
}

FakeComponent.prototype.setState = function (newState) {
  if ("renderer" in newState) this.state.renderer = newState.renderer;
  if ("rendered" in newState) this.state.rendered = newState.rendered;
};

//

function Renderer1(component, newProps) {
  var _this2 = this;

  var state = { renderer: this, rendered: component.rendered };
  this.component = new FakeComponent(state, newProps);
  this.handler = function (e) {
    return _this2.doHandle(e);
  };
  forEach(newProps.props, function (observable) {
    return observable.onAny(_this2.handler);
  });
  this.component = component;
  component.setState(state);
}

Renderer1.prototype.unsubscribe = function () {
  var handler = this.handler;
  if (handler) forEach(this.component.props.props, function (observable) {
    return observable.offAny(handler);
  });
};

Renderer1.prototype.doHandle = function (e) {
  switch (e.type) {
    case "value":
      {
        var component = this.component;
        var _component$props = component.props;
        var Class = _component$props.Class;
        var props = _component$props.props;

        var rendered = render(Class, props, [e.value]);
        if (!R.equals(component.state.rendered, rendered)) component.setState({ rendered: rendered });
        return;
      }
    case "error":
      config.onError(e.value);
      return;
    default:
      this.handler = null;
      this.component.setState(FromClassEnd);
      return;
  }
};

//

function RendererN(component, newProps, n) {
  var _this3 = this;

  var state = { renderer: this, rendered: component.rendered };
  this.component = new FakeComponent(state, newProps);
  this.handlers = [];
  this.values = Array(n);

  for (var i = 0; i < n; ++i) {
    this.values[i] = this;
  }forEach(newProps.props, function (observable) {
    var i = _this3.handlers.length;
    var handler = function handler(e) {
      return _this3.doHandle(i, e);
    };
    _this3.handlers.push(handler);
    observable.onAny(handler);
  });

  this.component = component;
  component.setState(state);
}

RendererN.prototype.unsubscribe = function () {
  var _this4 = this;

  var i = -1;
  forEach(this.component.props.props, function (observable) {
    var handler = _this4.handlers[++i];
    if (handler) observable.offAny(handler);
  });
};

RendererN.prototype.doHandle = function (idx, e) {
  switch (e.type) {
    case "value":
      {
        this.values[idx] = e.value;

        for (var i = this.values.length - 1; 0 <= i; --i) {
          if (this.values[i] === this) return;
        }var component = this.component;
        var _component$props2 = component.props;
        var Class = _component$props2.Class;
        var props = _component$props2.props;

        var rendered = render(Class, props, this.values);
        if (!R.equals(component.state.rendered, rendered)) component.setState({ rendered: rendered });
        return;
      }
    case "error":
      config.onError(e.value);
      return;
    default:
      {
        this.handlers[idx] = null;

        var n = this.handlers.length;

        if (n !== this.values.length) return;

        for (var _i = 0; _i < n; ++_i) {
          if (this.handlers[_i]) return;
        }this.component.setState(FromClassEnd);
        return;
      }
  }
};

//

var FromClassEnd = { renderer: null };
var FromClassNull = { renderer: null, rendered: null };

var FromClass = _react2.default.createClass(_extends({}, common, {
  getInitialState: function getInitialState() {
    return FromClassNull;
  },
  doUnsubscribe: function doUnsubscribe() {
    var renderer = this.state.renderer;

    if (renderer) renderer.unsubscribe();
  },
  doSubscribe: function doSubscribe(newProps) {
    var props = newProps.props;


    var n = 0;
    forEach(props, function () {
      return n += 1;
    });

    switch (n) {
      case 0:
        this.setState({ renderer: null,
          rendered: render(newProps.Class, props, null) });
        break;
      case 1:
        new Renderer1(this, newProps);
        break;
      default:
        new RendererN(this, newProps, n);
        break;
    }
  }
}));

var fromClass = exports.fromClass = function fromClass(Class) {
  return function (props) {
    return _react2.default.createElement(FromClass, { Class: Class, props: props });
  };
};

var fromClasses = exports.fromClasses = function fromClasses(classes) {
  var result = {};
  for (var k in classes) {
    result[k] = fromClass(classes[k]);
  }return result;
};

//

var K = Combine.asProperty;

//

var fromIds = exports.fromIds = function fromIds(ids, fromId) {
  return ids.scan(function (_ref2, ids) {
    var _ref3 = _slicedToArray(_ref2, 1);

    var oldIds = _ref3[0];

    var newIds = {};
    var newVs = Array(ids.length);
    for (var i = 0, n = ids.length; i < n; ++i) {
      var id = ids[i];
      var k = id.toString();
      if (k in newIds) newVs[i] = newIds[k];else newIds[k] = newVs[i] = k in oldIds ? oldIds[k] : fromId(id);
    }
    return [newIds, newVs];
  }, [{}, []]).map(function (s) {
    return s[1];
  });
};

//

exports.default = K;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9rZWZpci5yZWFjdC5uYXRpdmUuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7SUFBWSxDOztBQUNaOzs7O0FBQ0E7O0FBRUE7O0lBQVksTzs7Ozs7O0FBRVo7O0FBRU8sSUFBTSwwQkFBUztBQUNwQixXQUFTLG9CQUFLO0FBQUMsVUFBTSxDQUFOO0FBQVE7QUFESCxDQUFmOztBQUlQOztBQUVBLElBQU0sU0FBUztBQUNiLDJCQURhLHFDQUNhLFNBRGIsRUFDd0I7QUFDbkMsU0FBSyxhQUFMO0FBQ0EsU0FBSyxXQUFMLENBQWlCLFNBQWpCO0FBQ0QsR0FKWTtBQUtiLG9CQUxhLGdDQUtRO0FBQ25CLFNBQUssYUFBTDtBQUNBLFNBQUssV0FBTCxDQUFpQixLQUFLLEtBQXRCO0FBQ0QsR0FSWTtBQVNiLHVCQVRhLGlDQVNTLEVBVFQsRUFTYSxFQVRiLEVBU2lCO0FBQzVCLFdBQU8sR0FBRyxRQUFILEtBQWdCLEtBQUssS0FBTCxDQUFXLFFBQWxDO0FBQ0QsR0FYWTtBQVliLHNCQVphLGtDQVlVO0FBQ3JCLFNBQUssYUFBTDtBQUNBLFNBQUssUUFBTCxDQUFjLEtBQUssZUFBTCxFQUFkO0FBQ0QsR0FmWTtBQWdCYixRQWhCYSxvQkFnQko7QUFDUCxXQUFPLEtBQUssS0FBTCxDQUFXLFFBQWxCO0FBQ0Q7QUFsQlksQ0FBZjs7QUFxQkE7O0FBRUEsSUFBTSxlQUFlLEVBQUMsVUFBVSxJQUFYLEVBQXJCO0FBQ0EsSUFBTSxnQkFBZ0IsRUFBQyxVQUFVLElBQVgsRUFBaUIsVUFBVSxJQUEzQixFQUF0Qjs7QUFFQSxJQUFNLFlBQVksZ0JBQU0sV0FBTixjQUNiLE1BRGE7QUFFaEIsaUJBRmdCLDZCQUVFO0FBQ2hCLFdBQU8sYUFBUDtBQUNELEdBSmU7QUFLaEIsZUFMZ0IsMkJBS0E7QUFBQSxRQUNQLFFBRE8sR0FDSyxLQUFLLEtBRFYsQ0FDUCxRQURPOztBQUVkLFFBQUksUUFBSixFQUNFLEtBQUssS0FBTCxDQUFXLFVB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LENBQVMsaUJBQVcsR0FBWCxFQUFtQjtBQUFBOztBQUFBLFFBQWpCLE1BQWlCOztBQUNsRSxRQUFNLFNBQVMsRUFBZjtBQUNBLFFBQU0sUUFBUSxNQUFNLElBQUksTUFBVixDQUFkO0FBQ0EsU0FBSyxJQUFJLElBQUUsQ0FBTixFQUFTLElBQUUsSUFBSSxNQUFwQixFQUE0QixJQUFFLENBQTlCLEVBQWlDLEVBQUUsQ0FBbkMsRUFBc0M7QUFDcEMsVUFBTSxLQUFLLElBQUksQ0FBSixDQUFYO0FBQ0EsVUFBTSxJQUFJLEdBQUcsUUFBSCxFQUFWO0FBQ0EsVUFBSSxLQUFLLE1BQVQsRUFDRSxNQUFNLENBQU4sSUFBVyxPQUFPLENBQVAsQ0FBWCxDQURGLEtBR0UsT0FBTyxDQUFQLElBQVksTUFBTSxDQUFOLElBQVcsS0FBSyxNQUFMLEdBQWMsT0FBTyxDQUFQLENBQWQsR0FBMEIsT0FBTyxFQUFQLENBQWpEO0FBQ0g7QUFDRCxXQUFPLENBQUMsTUFBRCxFQUFTLEtBQVQsQ0FBUDtBQUNELEdBWnVDLEVBWXJDLENBQUMsRUFBRCxFQUFLLEVBQUwsQ0FacUMsRUFZM0IsR0FaMkIsQ0FZdkI7QUFBQSxXQUFLLEVBQUUsQ0FBRixDQUFMO0FBQUEsR0FadUIsQ0FBakI7QUFBQSxDQUFoQjs7QUFjUDs7a0JBRWUsQyIsImZpbGUiOiJrZWZpci5yZWFjdC5uYXRpdmUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBSICAgICAgIGZyb20gXCJyYW1kYVwiXG5pbXBvcnQgUmVhY3QgICAgICAgIGZyb20gXCJyZWFjdFwiXG5pbXBvcnQge09ic2VydmFibGV9IGZyb20gXCJrZWZpclwiXG5cbmltcG9ydCAqIGFzIENvbWJpbmUgZnJvbSBcIi4vY29tYmluZVwiXG5cbi8vXG5cbmV4cG9ydCBjb25zdCBjb25maWcgPSB7XG4gIG9uRXJyb3I6IGUgPT4ge3Rocm93IGV9XG59XG5cbi8vXG5cbmNvbnN0IGNvbW1vbiA9IHtcbiAgY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyhuZXh0UHJvcHMpIHtcbiAgICB0aGlzLmRvVW5zdWJzY3JpYmUoKVxuICAgIHRoaXMuZG9TdWJzY3JpYmUobmV4dFByb3BzKVxuICB9LFxuICBjb21wb25lbnRXaWxsTW91bnQoKSB7XG4gICAgdGhpcy5kb1Vuc3Vic2NyaWJlKClcbiAgICB0aGlzLmRvU3Vic2NyaWJlKHRoaXMucHJvcHMpXG4gIH0sXG4gIHNob3VsZENvbXBvbmVudFVwZGF0ZShucCwgbnMpIHtcbiAgICByZXR1cm4gbnMucmVuZGVyZWQgIT09IHRoaXMuc3RhdGUucmVuZGVyZWRcbiAgfSxcbiAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XG4gICAgdGhpcy5kb1Vuc3Vic2NyaWJlKClcbiAgICB0aGlzLnNldFN0YXRlKHRoaXMuZ2V0SW5pdGlhbFN0YXRlKCkpXG4gIH0sXG4gIHJlbmRlcigpIHtcbiAgICByZXR1cm4gdGhpcy5zdGF0ZS5yZW5kZXJlZFxuICB9XG59XG5cbi8vXG5cbmNvbnN0IEZyb21LZWZpckVuZCA9IHtjYWxsYmFjazogbnVsbH1cbmNvbnN0IEZyb21LZWZpck51bGwgPSB7Y2FsbGJhY2s6IG51bGwsIHJlbmRlcmVkOiBudWxsfVxuXG5jb25zdCBGcm9tS2VmaXIgPSBSZWFjdC5jcmVhdGVDbGFzcyh7XG4gIC4uLmNvbW1vbixcbiAgZ2V0SW5pdGlhbFN0YXRlKCkge1xuICAgIHJldHVybiBGcm9tS2VmaXJOdWxsXG4gIH0sXG4gIGRvVW5zdWJzY3JpYmUoKSB7XG4gICAgY29uc3Qge2NhbGxiYWNrfSA9IHRoaXMuc3RhdGVcbiAgICBpZiAoY2FsbGJhY2spXG4gICAgICB0aGlzLnByb3BzLm9ic2VydmFibGUub2ZmQW55KGNhbGxiYWNrKVxuICB9LFxuICBkb1N1YnNjcmliZSh7b2JzZXJ2YWJsZX0pIHtcbiAgICBpZiAob2JzZXJ2YWJsZSBpbnN0YW5jZW9mIE9ic2VydmFibGUpIHtcbiAgICAgIGNvbnN0IGNhbGxiYWNrID0gZSA9PiB7XG4gICAgICAgIHN3aXRjaCAoZS50eXBlKSB7XG4gICAgICAgICAgY2FzZSBcInZhbHVlXCI6XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHtyZW5kZXJlZDogZS52YWx1ZX0pXG4gICAgICAgICAgICBicmVha1xuICAgICAgICAgIGNhc2UgXCJlcnJvclwiOlxuICAgICAgICAgICAgY29uZmlnLm9uRXJyb3IoZS52YWx1ZSlcbiAgICAgICAgICAgIGJyZWFrXG4gICAgICAgICAgY2FzZSBcImVuZFwiOlxuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZShGcm9tS2VmaXJFbmQpXG4gICAgICAgICAgICBicmVha1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBvYnNlcnZhYmxlLm9uQW55KGNhbGxiYWNrKVxuICAgICAgdGhpcy5zZXRTdGF0ZSh7Y2FsbGJhY2t9KVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnNldFN0YXRlKHtyZW5kZXJlZDogb2JzZXJ2YWJsZX0pXG4gICAgfVxuICB9XG59KVxuXG5leHBvcnQgY29uc3QgZnJvbUtlZmlyID0gb2JzZXJ2YWJsZSA9PlxuICBSZWFjdC5jcmVhdGVFbGVtZW50KEZyb21LZWZpciwge29ic2VydmFibGV9KVxuXG4vL1xuXG5mdW5jdGlvbiBmb3JFYWNoKHByb3BzLCBmbikge1xuICBmb3IgKGNvbnN0IGtleSBpbiBwcm9wcykge1xuICAgIGNvbnN0IHZhbCA9IHByb3BzW2tleV1cbiAgICBpZiAodmFsIGluc3RhbmNlb2YgT2JzZXJ2YWJsZSkge1xuICAgICAgZm4odmFsKVxuICAgIH0gZWxzZSBpZiAoXCJjaGlsZHJlblwiID09PSBrZXkgJiZcbiAgICAgICAgICAgICAgIHZhbCBpbnN0YW5jZW9mIEFycmF5KSB7XG4gICAgICBmb3IgKGxldCBpPTAsIG49dmFsLmxlbmd0aDsgaTxuOyArK2kpIHtcbiAgICAgICAgY29uc3QgdmFsSSA9IHZhbFtpXVxuICAgICAgICBpZiAodmFsSSBpbnN0YW5jZW9mIE9ic2VydmFibGUpXG4gICAgICAgICAgZm4odmFsSSlcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gcmVuZGVyKENsYXNzLCBwcm9wcywgdmFsdWVzKSB7XG4gIGNvbnN0IG5ld1Byb3BzID0ge31cbiAgbGV0IG5ld0NoaWxkcmVuXG5cbiAgbGV0IGsgPSAtMVxuXG4gIGZvciAoY29uc3Qga2V5IGluIHByb3BzKSB7XG4gICAgY29uc3QgdmFsID0gcHJvcHNba2V5XVxuICAgIGlmICh2YWwgaW5zdGFuY2VvZiBPYnNlcnZhYmxlKSB7XG4gICAgICBjb25zdCB2YWxPID0gdmFsdWVzWysra11cbiAgICAgIGlmIChcImNoaWxkcmVuXCIgPT09IGtleSlcbiAgICAgICAgbmV3Q2hpbGRyZW4gPSB2YWxPXG4gICAgICBlbHNlIGlmIChcIm1vdW50XCIgPT09IGtleSlcbiAgICAgICAgbmV3UHJvcHMucmVmID0gdmFsT1xuICAgICAgZWxzZVxuICAgICAgICBuZXdQcm9wc1trZXldID0gdmFsT1xuICAgIH0gZWxzZSBpZiAoXCJjaGlsZHJlblwiID09PSBrZXkpIHtcbiAgICAgIGlmICh2YWwgaW5zdGFuY2VvZiBBcnJheSkge1xuICAgICAgICBmb3IgKGxldCBpPTAsIG49dmFsLmxlbmd0aDsgaTxuOyArK2kpIHtcbiAgICAgICAgICBjb25zdCB2YWxJID0gdmFsW2ldXG4gICAgICAgICAgaWYgKHZhbEkgaW5zdGFuY2VvZiBPYnNlcnZhYmxlKSB7XG4gICAgICAgICAgICBpZiAoIW5ld0NoaWxkcmVuKSB7XG4gICAgICAgICAgICAgIG5ld0NoaWxkcmVuID0gQXJyYXkodmFsLmxlbmd0aClcbiAgICAgICAgICAgICAgZm9yIChsZXQgaj0wOyBqPGk7ICsrailcbiAgICAgICAgICAgICAgICBuZXdDaGlsZHJlbltqXSA9IHZhbFtqXVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbmV3Q2hpbGRyZW5baV0gPSB2YWx1ZXNbKytrXVxuICAgICAgICAgIH0gZWxzZSBpZiAobmV3Q2hpbGRyZW4pIHtcbiAgICAgICAgICAgIG5ld0NoaWxkcmVuW2ldID0gdmFsW2ldXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICBpZiAoIW5ld0NoaWxkcmVuKVxuICAgICAgICBuZXdDaGlsZHJlbiA9IHZhbFxuICAgIH0gZWxzZSBpZiAoXCJtb3VudFwiID09PSBrZXkpIHtcbiAgICAgIG5ld1Byb3BzLnJlZiA9IHZhbFxuICAgIH0gZWxzZSB7XG4gICAgICBuZXdQcm9wc1trZXldID0gdmFsXG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoQ2xhc3MsIG5ld1Byb3BzLCBuZXdDaGlsZHJlbiB8fCBudWxsKVxufVxuXG4vL1xuXG5mdW5jdGlvbiBGYWtlQ29tcG9uZW50KHN0YXRlLCBwcm9wcykge1xuICB0aGlzLnByb3BzID0gcHJvcHNcbiAgdGhpcy5zdGF0ZSA9IHN0YXRlXG59XG5cbkZha2VDb21wb25lbnQucHJvdG90eXBlLnNldFN0YXRlID0gZnVuY3Rpb24gKG5ld1N0YXRlKSB7XG4gIGlmIChcInJlbmRlcmVyXCIgaW4gbmV3U3RhdGUpXG4gICAgdGhpcy5zdGF0ZS5yZW5kZXJlciA9IG5ld1N0YXRlLnJlbmRlcmVyXG4gIGlmIChcInJlbmRlcmVkXCIgaW4gbmV3U3RhdGUpXG4gICAgdGhpcy5zdGF0ZS5yZW5kZXJlZCA9IG5ld1N0YXRlLnJlbmRlcmVkXG59XG5cbi8vXG5cbmZ1bmN0aW9uIFJlbmRlcmVyMShjb21wb25lbnQsIG5ld1Byb3BzKSB7XG4gIGNvbnN0IHN0YXRlID0ge3JlbmRlcmVyOiB0aGlzLCByZW5kZXJlZDogY29tcG9uZW50LnJlbmRlcmVkfVxuICB0aGlzLmNvbXBvbmVudCA9IG5ldyBGYWtlQ29tcG9uZW50KHN0YXRlLCBuZXdQcm9wcylcbiAgdGhpcy5oYW5kbGVyID0gZSA9PiB0aGlzLmRvSGFuZGxlKGUpXG4gIGZvckVhY2gobmV3UHJvcHMucHJvcHMsIG9ic2VydmFibGUgPT4gb2JzZXJ2YWJsZS5vbkFueSh0aGlzLmhhbmRsZXIpKVxuICB0aGlzLmNvbXBvbmVudCA9IGNvbXBvbmVudFxuICBjb21wb25lbnQuc2V0U3RhdGUoc3RhdGUpXG59XG5cblJlbmRlcmVyMS5wcm90b3R5cGUudW5zdWJzY3JpYmUgPSBmdW5jdGlvbiAoKSB7XG4gIGNvbnN0IGhhbmRsZXIgPSB0aGlzLmhhbmRsZXJcbiAgaWYgKGhhbmRsZXIpXG4gICAgZm9yRWFjaCh0aGlzLmNvbXBvbmVudC5wcm9wcy5wcm9wcywgb2JzZXJ2YWJsZSA9PiBvYnNlcnZhYmxlLm9mZkFueShoYW5kbGVyKSlcbn1cblxuUmVuZGVyZXIxLnByb3RvdHlwZS5kb0hhbmRsZSA9IGZ1bmN0aW9uIChlKSB7XG4gIHN3aXRjaCAoZS50eXBlKSB7XG4gICAgY2FzZSBcInZhbHVlXCI6IHtcbiAgICAgIGNvbnN0IGNvbXBvbmVudCA9IHRoaXMuY29tcG9uZW50XG4gICAgICBjb25zdCB7Q2xhc3MsIHByb3BzfSA9IGNvbXBvbmVudC5wcm9wc1xuICAgICAgY29uc3QgcmVuZGVyZWQgPSByZW5kZXIoQ2xhc3MsIHByb3BzLCBbZS52YWx1ZV0pXG4gICAgICBpZiAoIVIuZXF1YWxzKGNvbXBvbmVudC5zdGF0ZS5yZW5kZXJlZCwgcmVuZGVyZWQpKVxuICAgICAgICBjb21wb25lbnQuc2V0U3RhdGUoe3JlbmRlcmVkfSlcbiAgICAgIHJldHVyblxuICAgIH1cbiAgICBjYXNlIFwiZXJyb3JcIjpcbiAgICAgIGNvbmZpZy5vbkVycm9yKGUudmFsdWUpXG4gICAgICByZXR1cm5cbiAgICBkZWZhdWx0OlxuICAgICAgdGhpcy5oYW5kbGVyID0gbnVsbFxuICAgICAgdGhpcy5jb21wb25lbnQuc2V0U3RhdGUoRnJvbUNsYXNzRW5kKVxuICAgICAgcmV0dXJuXG4gIH1cbn1cblxuLy9cblxuZnVuY3Rpb24gUmVuZGVyZXJOKGNvbXBvbmVudCwgbmV3UHJvcHMsIG4pIHtcbiAgY29uc3Qgc3RhdGUgPSB7cmVuZGVyZXI6IHRoaXMsIHJlbmRlcmVkOiBjb21wb25lbnQucmVuZGVyZWR9XG4gIHRoaXMuY29tcG9uZW50ID0gbmV3IEZha2VDb21wb25lbnQoc3RhdGUsIG5ld1Byb3BzKVxuICB0aGlzLmhhbmRsZXJzID0gW11cbiAgdGhpcy52YWx1ZXMgPSBBcnJheShuKVxuXG4gIGZvciAobGV0IGk9MDsgaTxuOyArK2kpXG4gICAgdGhpcy52YWx1ZXNbaV0gPSB0aGlzXG5cbiAgZm9yRWFjaChuZXdQcm9wcy5wcm9wcywgb2JzZXJ2YWJsZSA9PiB7XG4gICAgY29uc3QgaSA9IHRoaXMuaGFuZGxlcnMubGVuZ3RoXG4gICAgY29uc3QgaGFuZGxlciA9IGUgPT4gdGhpcy5kb0hhbmRsZShpLCBlKVxuICAgIHRoaXMuaGFuZGxlcnMucHVzaChoYW5kbGVyKVxuICAgIG9ic2VydmFibGUub25BbnkoaGFuZGxlcilcbiAgfSlcblxuICB0aGlzLmNvbXBvbmVudCA9IGNvbXBvbmVudFxuICBjb21wb25lbnQuc2V0U3RhdGUoc3RhdGUpXG59XG5cblJlbmRlcmVyTi5wcm90b3R5cGUudW5zdWJzY3JpYmUgPSBmdW5jdGlvbiAoKSB7XG4gIGxldCBpID0gLTFcbiAgZm9yRWFjaCh0aGlzLmNvbXBvbmVudC5wcm9wcy5wcm9wcywgb2JzZXJ2YWJsZSA9PiB7XG4gICAgY29uc3QgaGFuZGxlciA9IHRoaXMuaGFuZGxlcnNbKytpXVxuICAgIGlmIChoYW5kbGVyKVxuICAgICAgb2JzZXJ2YWJsZS5vZmZBbnkoaGFuZGxlcilcbiAgfSlcbn1cblxuUmVuZGVyZXJOLnByb3RvdHlwZS5kb0hhbmRsZSA9IGZ1bmN0aW9uIChpZHgsIGUpIHtcbiAgc3dpdGNoIChlLnR5cGUpIHtcbiAgICBjYXNlIFwidmFsdWVcIjoge1xuICAgICAgdGhpcy52YWx1ZXNbaWR4XSA9IGUudmFsdWVcblxuICAgICAgZm9yIChsZXQgaT10aGlzLnZhbHVlcy5sZW5ndGgtMTsgMCA8PSBpOyAtLWkpXG4gICAgICAgIGlmICh0aGlzLnZhbHVlc1tpXSA9PT0gdGhpcylcbiAgICAgICAgICByZXR1cm5cblxuICAgICAgY29uc3QgY29tcG9uZW50ID0gdGhpcy5jb21wb25lbnRcbiAgICAgIGNvbnN0IHtDbGFzcywgcHJvcHN9ID0gY29tcG9uZW50LnByb3BzXG4gICAgICBjb25zdCByZW5kZXJlZCA9IHJlbmRlcihDbGFzcywgcHJvcHMsIHRoaXMudmFsdWVzKVxuICAgICAgaWYgKCFSLmVxdWFscyhjb21wb25lbnQuc3RhdGUucmVuZGVyZWQsIHJlbmRlcmVkKSlcbiAgICAgICAgY29tcG9uZW50LnNldFN0YXRlKHtyZW5kZXJlZH0pXG4gICAgICByZXR1cm5cbiAgICB9XG4gICAgY2FzZSBcImVycm9yXCI6XG4gICAgICBjb25maWcub25FcnJvcihlLnZhbHVlKVxuICAgICAgcmV0dXJuXG4gICAgZGVmYXVsdDoge1xuICAgICAgdGhpcy5oYW5kbGVyc1tpZHhdID0gbnVsbFxuXG4gICAgICBjb25zdCBuID0gdGhpcy5oYW5kbGVycy5sZW5ndGhcblxuICAgICAgaWYgKG4gIT09IHRoaXMudmFsdWVzLmxlbmd0aClcbiAgICAgICAgcmV0dXJuXG5cbiAgICAgIGZvciAobGV0IGk9MDsgaSA8IG47ICsraSlcbiAgICAgICAgaWYgKHRoaXMuaGFuZGxlcnNbaV0pXG4gICAgICAgICAgcmV0dXJuXG5cbiAgICAgIHRoaXMuY29tcG9uZW50LnNldFN0YXRlKEZyb21DbGFzc0VuZClcbiAgICAgIHJldHVyblxuICAgIH1cbiAgfVxufVxuXG4vL1xuXG5jb25zdCBGcm9tQ2xhc3NFbmQgPSB7cmVuZGVyZXI6IG51bGx9XG5jb25zdCBGcm9tQ2xhc3NOdWxsID0ge3JlbmRlcmVyOiBudWxsLCByZW5kZXJlZDogbnVsbH1cblxuY29uc3QgRnJvbUNsYXNzID0gUmVhY3QuY3JlYXRlQ2xhc3Moe1xuICAuLi5jb21tb24sXG4gIGdldEluaXRpYWxTdGF0ZSgpIHtcbiAgICByZXR1cm4gRnJvbUNsYXNzTnVsbFxuICB9LFxuICBkb1Vuc3Vic2NyaWJlKCkge1xuICAgIGNvbnN0IHtyZW5kZXJlcn0gPSB0aGlzLnN0YXRlXG4gICAgaWYgKHJlbmRlcmVyKVxuICAgICAgcmVuZGVyZXIudW5zdWJzY3JpYmUoKVxuICB9LFxuICBkb1N1YnNjcmliZShuZXdQcm9wcykge1xuICAgIGNvbnN0IHtwcm9wc30gPSBuZXdQcm9wc1xuXG4gICAgbGV0IG4gPSAwXG4gICAgZm9yRWFjaChwcm9wcywgKCkgPT4gbiArPSAxKVxuXG4gICAgc3dpdGNoIChuKSB7XG4gICAgICBjYXNlIDA6XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe3JlbmRlcmVyOiBudWxsLFxuICAgICAgICAgICAgICAgICAgICAgICByZW5kZXJlZDogcmVuZGVyKG5ld1Byb3BzLkNsYXNzLCBwcm9wcywgbnVsbCl9KVxuICAgICAgICBicmVha1xuICAgICAgY2FzZSAxOlxuICAgICAgICBuZXcgUmVuZGVyZXIxKHRoaXMsIG5ld1Byb3BzKVxuICAgICAgICBicmVha1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgbmV3IFJlbmRlcmVyTih0aGlzLCBuZXdQcm9wcywgbilcbiAgICAgICAgYnJlYWtcbiAgICB9XG4gIH1cbn0pXG5cbmV4cG9ydCBjb25zdCBmcm9tQ2xhc3MgPVxuICBDbGFzcyA9PiBwcm9wcyA9PiBSZWFjdC5jcmVhdGVFbGVtZW50KEZyb21DbGFzcywge0NsYXNzLCBwcm9wc30pXG5cbmV4cG9ydCBjb25zdCBmcm9tQ2xhc3NlcyA9IGNsYXNzZXMgPT4ge1xuICBjb25zdCByZXN1bHQgPSB7fVxuICBmb3IgKGNvbnN0IGsgaW4gY2xhc3NlcylcbiAgICByZXN1bHRba10gPSBmcm9tQ2xhc3MoY2xhc3Nlc1trXSlcbiAgcmV0dXJuIHJlc3VsdFxufVxuXG4vL1xuXG5jb25zdCBLID0gQ29tYmluZS5hc1Byb3BlcnR5XG5cbi8vXG5cbmV4cG9ydCBjb25zdCBmcm9tSWRzID0gKGlkcywgZnJvbUlkKSA9PiBpZHMuc2NhbigoW29sZElkc10sIGlkcykgPT4ge1xuICBjb25zdCBuZXdJZHMgPSB7fVxuICBjb25zdCBuZXdWcyA9IEFycmF5KGlkcy5sZW5ndGgpXG4gIGZvciAobGV0IGk9MCwgbj1pZHMubGVuZ3RoOyBpPG47ICsraSkge1xuICAgIGNvbnN0IGlkID0gaWRzW2ldXG4gICAgY29uc3QgayA9IGlkLnRvU3RyaW5nKClcbiAgICBpZiAoayBpbiBuZXdJZHMpXG4gICAgICBuZXdWc1tpXSA9IG5ld0lkc1trXVxuICAgIGVsc2VcbiAgICAgIG5ld0lkc1trXSA9IG5ld1ZzW2ldID0gayBpbiBvbGRJZHMgPyBvbGRJZHNba10gOiBmcm9tSWQoaWQpXG4gIH1cbiAgcmV0dXJuIFtuZXdJZHMsIG5ld1ZzXVxufSwgW3t9LCBbXV0pLm1hcChzID0+IHNbMV0pXG5cbi8vXG5cbmV4cG9ydCBkZWZhdWx0IEtcbiJdfQ==