"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Molecule = exports.Atom = exports.LensedAtom = exports.MutableWithSource = exports.AbstractMutable = exports.holding = undefined;

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _kefir = require("kefir");

var Kefir = _interopRequireWildcard(_kefir);

var _ramda = require("ramda");

var R = _interopRequireWildcard(_ramda);

var _partial = require("partial.lenses");

var L = _interopRequireWildcard(_partial);

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

//

var lock = 0;

var prevs = [];
var atoms = [];

var release = function release() {
  while (prevs.length) {
    var prev = prevs.pop();
    var atom = atoms.pop();
    var next = atom._currentEvent.value;

    if (!R.equals(prev, next)) atom._emitValue(next);
  }
};

var holding = exports.holding = function holding(ef) {
  ++lock;
  try {
    return ef();
  } finally {
    if (! --lock) release();
  }
};

//

var AbstractMutable = exports.AbstractMutable = function (_Kefir$Property) {
  _inherits(AbstractMutable, _Kefir$Property);

  function AbstractMutable() {
    _classCallCheck(this, AbstractMutable);

    return _possibleConstructorReturn(this, (AbstractMutable.__proto__ || Object.getPrototypeOf(AbstractMutable)).apply(this, arguments));
  }

  _createClass(AbstractMutable, [{
    key: "set",
    value: function set(value) {
      this.modify(function () {
        return value;
      });
    }
  }, {
    key: "remove",
    value: function remove() {
      this.set();
    }
  }, {
    key: "lens",
    value: function lens() {
      return new LensedAtom(this, L.default.apply(undefined, arguments));
    }
  }, {
    key: "view",
    value: function view() {
      return this.lens.apply(this, arguments);
    }
  }, {
    key: "_maybeEmitValue",
    value: function _maybeEmitValue(next) {
      var prev = this._currentEvent;
      if (!prev || !R.equals(prev.value, next)) this._emitValue(next);
    }
  }]);

  return AbstractMutable;
}(Kefir.Property);

//

var MutableWithSource = exports.MutableWithSource = function (_AbstractMutable) {
  _inherits(MutableWithSource, _AbstractMutable);

  function MutableWithSource(source) {
    _classCallCheck(this, MutableWithSource);

    var _this2 = _possibleConstructorReturn(this, (MutableWithSource.__proto__ || Object.getPrototypeOf(MutableWithSource)).call(this));

    _this2._source = source;
    _this2._$handleValue = null;
    return _this2;
  }

  _createClass(MutableWithSource, [{
    key: "get",
    value: function get() {
      var current = this._currentEvent;
      if (current && !lock) return current.value;else return this._getFromSource();
    }
  }, {
    key: "_handleValue",
    value: function _handleValue() {
      this._maybeEmitValue(this._getFromSource());
    }
  }, {
    key: "_onActivation",
    value: function _onActivation() {
      var _this3 = this;

      var handleValue = function handleValue(value) {
        return _this3._handleValue(value);
      };
      this._$handleValue = handleValue;
      this._source.onValue(handleValue);
    }
  }, {
    key: "_onDeactivation",
    value: function _onDeactivation() {
      this._source.offValue(this._$handleValue);
      this._$handleValue = null;
      this._currentEvent = null;
    }
  }]);

  return MutableWithSource;
}(AbstractMutable);

//

var LensedAtom = exports.LensedAtom = function (_MutableWithSource) {
  _inherits(LensedAtom, _MutableWithSource);

  function LensedAtom(source, lens) {
    _classCallCheck(this, LensedAtom);

    var _this4 = _possibleConstructorReturn(this, (LensedAtom.__proto__ || Object.getPrototypeOf(LensedAtom)).call(this, source));

    _this4._lens = lens;
    return _this4;
  }

  _createClass(LensedAtom, [{
    key: "modify",
    value: function modify(fn) {
      this._source.modify(L.modify(this._lens, fn));
    }
  }, {
    key: "_getFromSource",
    value: function _getFromSource() {
      return L.get(this._lens, this._source.get());
    }
  }]);

  return LensedAtom;
}(MutableWithSource);

//

var Atom = exports.Atom = function (_AbstractMutable2) {
  _inherits(Atom, _AbstractMutable2);

  function Atom(value) {
    _classCallCheck(this, Atom);

    var _this5 = _possibleConstructorReturn(this, (Atom.__proto__ || Object.getPrototypeOf(Atom)).call(this));

    _this5._emitValue(value);
    return _this5;
  }

  _createClass(Atom, [{
    key: "get",
    value: function get() {
      return this._currentEvent.value;
    }
  }, {
    key: "modify",
    value: function modify(fn) {
      var _this6 = this;

      var current = this._currentEvent;
      var prev = current.value;
      var next = fn(prev);
      if (lock) {
        if (!atoms.find(function (x) {
          return x === _this6;
        })) {
          prevs.push(prev);
          atoms.push(this);
        }
        current.value = next;
      } else {
        this._maybeEmitValue(next);
      }
    }
  }]);

  return Atom;
}(AbstractMutable);

//

var constructorOf = function constructorOf(x) {
  return x && x.constructor;
};

function getMutables(template) {
  var mutables = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];

  if (template instanceof AbstractMutable && !mutables.find(function (m) {
    return m === template;
  })) {
    mutables.push(template);
  } else {
    var _constructor = constructorOf(template);

    if (_constructor === Array) for (var i = 0, n = template.length; i < n; ++i) {
      getMutables(template[i], mutables);
    } else if (_constructor === Object) for (var k in template) {
      getMutables(template[k], mutables);
    }
  }
  return mutables;
}

function combine(template) {
  if (template instanceof AbstractMutable) {
    return template.get();
  } else {
    var _constructor2 = constructorOf(template);

    if (_constructor2 === Array) {
      var n = template.length;
      var next = Array(n);
      for (var i = 0; i < n; ++i) {
        next[i] = combine(template[i]);
      }return next;
    } else if (_constructor2 === Object) {
      var _next = {};
      for (var k in template) {
        _next[k] = combine(template[k]);
      }return _next;
    } else {
      return template;
    }
  }
}

var mismatch = function mismatch() {
  throw new Error("Molecule cannot change the template.");
};

function setMutables(template, value) {
  if (template instanceof AbstractMutable) {
    return template.set(value);
  } else {
    var _constructor3 = constructorOf(template);

    if (_constructor3 !== constructorOf(value)) mismatch();

    if (_constructor3 === Array) for (var i = 0, n = template.length; i < n; ++i) {
      setMutables(template[i], value[i]);
    } else if (_constructor3 === Object) for (var k in template) {
      setMutables(template[k], value[k]);
    } else if (!R.equals(template, value)) mismatch();
  }
}

var Molecule = exports.Molecule = function (_MutableWithSource2) {
  _inherits(Molecule, _MutableWithSource2);

  function Molecule(template) {
    _classCallCheck(this, Molecule);

    var _this7 = _possibleConstructorReturn(this, (Molecule.__proto__ || Object.getPrototypeOf(Molecule)).call(this, Kefir.combine(getMutables(template))));

    _this7._template = template;
    return _this7;
  }

  _createClass(Molecule, [{
    key: "_getFromSource",
    value: function _getFromSource() {
      return combine(this._template);
    }
  }, {
    key: "modify",
    value: function modify(fn) {
      var _this8 = this;

      var next = fn(this.get());
      holding(function () {
        return setMutables(_this8._template, next);
      });
    }
  }]);

  return Molecule;
}(MutableWithSource);

//

exports.default = function (value) {
  return new Atom(value);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9rZWZpci5hdG9tLmpzIl0sIm5hbWVzIjpbIktlZmlyIiwiUiIsIkwiLCJsb2NrIiwicHJldnMiLCJhdG9tcyIsInJlbGVhc2UiLCJsZW5ndGgiLCJwcmV2IiwicG9wIiwiYXRvbSIsIm5leHQiLCJfY3VycmVudEV2ZW50IiwidmFsdWUiLCJlcXVhbHMiLCJfZW1pdFZhbHVlIiwiaG9sZGluZyIsImVmIiwiQWJzdHJhY3RNdXRhYmxlIiwibW9kaWZ5Iiwic2V0IiwiTGVuc2VkQXRvbSIsImxlbnMiLCJQcm9wZXJ0eSIsIk11dGFibGVXaXRoU291cmNlIiwic291cmNlIiwiX3NvdXJjZSIsIl8kaGFuZGxlVmFsdWUiLCJjdXJyZW50IiwiX2dldEZyb21Tb3VyY2UiLCJfbWF5YmVFbWl0VmFsdWUiLCJoYW5kbGVWYWx1ZSIsIl9oYW5kbGVWYWx1ZSIsIm9uVmFsdWUiLCJvZmZWYWx1ZSIsIl9sZW5zIiwiZm4iLCJnZXQiLCJBdG9tIiwiZmluZCIsIngiLCJwdXNoIiwiY29uc3RydWN0b3JPZiIsImNvbnN0cnVjdG9yIiwiZ2V0TXV0YWJsZXMiLCJ0ZW1wbGF0ZSIsIm11dGFibGVzIiwibSIsIkFycmF5IiwiaSIsIm4iLCJPYmplY3QiLCJrIiwiY29tYmluZSIsIm1pc21hdGNoIiwiRXJyb3IiLCJzZXRNdXRhYmxlcyIsIk1vbGVjdWxlIiwiX3RlbXBsYXRlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQTs7SUFBWUEsSzs7QUFDWjs7SUFBWUMsQzs7QUFDWjs7SUFBZUMsQzs7Ozs7Ozs7OztBQUVmOztBQUVBLElBQUlDLE9BQU8sQ0FBWDs7QUFFQSxJQUFNQyxRQUFRLEVBQWQ7QUFDQSxJQUFNQyxRQUFRLEVBQWQ7O0FBRUEsSUFBTUMsVUFBVSxTQUFWQSxPQUFVLEdBQU07QUFDcEIsU0FBT0YsTUFBTUcsTUFBYixFQUFxQjtBQUNuQixRQUFNQyxPQUFPSixNQUFNSyxHQUFOLEVBQWI7QUFDQSxRQUFNQyxPQUFPTCxNQUFNSSxHQUFOLEVBQWI7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LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgS2VmaXIgZnJvbSBcImtlZmlyXCJcbmltcG9ydCAqIGFzIFIgICAgIGZyb20gXCJyYW1kYVwiXG5pbXBvcnQgUCwgKiBhcyBMICBmcm9tIFwicGFydGlhbC5sZW5zZXNcIlxuXG4vL1xuXG5sZXQgbG9jayA9IDBcblxuY29uc3QgcHJldnMgPSBbXVxuY29uc3QgYXRvbXMgPSBbXVxuXG5jb25zdCByZWxlYXNlID0gKCkgPT4ge1xuICB3aGlsZSAocHJldnMubGVuZ3RoKSB7XG4gICAgY29uc3QgcHJldiA9IHByZXZzLnBvcCgpXG4gICAgY29uc3QgYXRvbSA9IGF0b21zLnBvcCgpXG4gICAgY29uc3QgbmV4dCA9IGF0b20uX2N1cnJlbnRFdmVudC52YWx1ZVxuXG4gICAgaWYgKCFSLmVxdWFscyhwcmV2LCBuZXh0KSlcbiAgICAgIGF0b20uX2VtaXRWYWx1ZShuZXh0KVxuICB9XG59XG5cbmV4cG9ydCBjb25zdCBob2xkaW5nID0gZWYgPT4ge1xuICArK2xvY2tcbiAgdHJ5IHtcbiAgICByZXR1cm4gZWYoKVxuICB9IGZpbmFsbHkge1xuICAgIGlmICghLS1sb2NrKVxuICAgICAgcmVsZWFzZSgpXG4gIH1cbn1cblxuLy9cblxuZXhwb3J0IGNsYXNzIEFic3RyYWN0TXV0YWJsZSBleHRlbmRzIEtlZmlyLlByb3BlcnR5IHtcbiAgc2V0KHZhbHVlKSB7XG4gICAgdGhpcy5tb2RpZnkoKCkgPT4gdmFsdWUpXG4gIH1cbiAgcmVtb3ZlKCkge1xuICAgIHRoaXMuc2V0KClcbiAgfVxuICBsZW5zKC4uLmxzKSB7XG4gICAgcmV0dXJuIG5ldyBMZW5zZWRBdG9tKHRoaXMsIFAoLi4ubHMpKVxuICB9XG4gIHZpZXcoLi4ubHMpIHtcbiAgICByZXR1cm4gdGhpcy5sZW5zKC4uLmxzKVxuICB9XG4gIF9tYXliZUVtaXRWYWx1ZShuZXh0KSB7XG4gICAgY29uc3QgcHJldiA9IHRoaXMuX2N1cnJlbnRFdmVudFxuICAgIGlmICghcHJldiB8fCAhUi5lcXVhbHMocHJldi52YWx1ZSwgbmV4dCkpXG4gICAgICB0aGlzLl9lbWl0VmFsdWUobmV4dClcbiAgfVxufVxuXG4vL1xuXG5leHBvcnQgY2xhc3MgTXV0YWJsZVdpdGhTb3VyY2UgZXh0ZW5kcyBBYnN0cmFjdE11dGFibGUge1xuICBjb25zdHJ1Y3Rvcihzb3VyY2UpIHtcbiAgICBzdXBlcigpXG4gICAgdGhpcy5fc291cmNlID0gc291cmNlXG4gICAgdGhpcy5fJGhhbmRsZVZhbHVlID0gbnVsbFxuICB9XG4gIGdldCgpIHtcbiAgICBjb25zdCBjdXJyZW50ID0gdGhpcy5fY3VycmVudEV2ZW50XG4gICAgaWYgKGN1cnJlbnQgJiYgIWxvY2spXG4gICAgICByZXR1cm4gY3VycmVudC52YWx1ZVxuICAgIGVsc2VcbiAgICAgIHJldHVybiB0aGlzLl9nZXRGcm9tU291cmNlKClcbiAgfVxuICBfaGFuZGxlVmFsdWUoKSB7XG4gICAgdGhpcy5fbWF5YmVFbWl0VmFsdWUodGhpcy5fZ2V0RnJvbVNvdXJjZSgpKVxuICB9XG4gIF9vbkFjdGl2YXRpb24oKSB7XG4gICAgY29uc3QgaGFuZGxlVmFsdWUgPSB2YWx1ZSA9PiB0aGlzLl9oYW5kbGVWYWx1ZSh2YWx1ZSlcbiAgICB0aGlzLl8kaGFuZGxlVmFsdWUgPSBoYW5kbGVWYWx1ZVxuICAgIHRoaXMuX3NvdXJjZS5vblZhbHVlKGhhbmRsZVZhbHVlKVxuICB9XG4gIF9vbkRlYWN0aXZhdGlvbigpIHtcbiAgICB0aGlzLl9zb3VyY2Uub2ZmVmFsdWUodGhpcy5fJGhhbmRsZVZhbHVlKVxuICAgIHRoaXMuXyRoYW5kbGVWYWx1ZSA9IG51bGxcbiAgICB0aGlzLl9jdXJyZW50RXZlbnQgPSBudWxsXG4gIH1cbn1cblxuLy9cblxuZXhwb3J0IGNsYXNzIExlbnNlZEF0b20gZXh0ZW5kcyBNdXRhYmxlV2l0aFNvdXJjZSB7XG4gIGNvbnN0cnVjdG9yKHNvdXJjZSwgbGVucykge1xuICAgIHN1cGVyKHNvdXJjZSlcbiAgICB0aGlzLl9sZW5zID0gbGVuc1xuICB9XG4gIG1vZGlmeShmbikge1xuICAgIHRoaXMuX3NvdXJjZS5tb2RpZnkoTC5tb2RpZnkodGhpcy5fbGVucywgZm4pKVxuICB9XG4gIF9nZXRGcm9tU291cmNlKCkge1xuICAgIHJldHVybiBMLmdldCh0aGlzLl9sZW5zLCB0aGlzLl9zb3VyY2UuZ2V0KCkpXG4gIH1cbn1cblxuLy9cblxuZXhwb3J0IGNsYXNzIEF0b20gZXh0ZW5kcyBBYnN0cmFjdE11dGFibGUge1xuICBjb25zdHJ1Y3Rvcih2YWx1ZSkge1xuICAgIHN1cGVyKClcbiAgICB0aGlzLl9lbWl0VmFsdWUodmFsdWUpXG4gIH1cbiAgZ2V0KCkge1xuICAgIHJldHVybiB0aGlzLl9jdXJyZW50RXZlbnQudmFsdWVcbiAgfVxuICBtb2RpZnkoZm4pIHtcbiAgICBjb25zdCBjdXJyZW50ID0gdGhpcy5fY3VycmVudEV2ZW50XG4gICAgY29uc3QgcHJldiA9IGN1cnJlbnQudmFsdWVcbiAgICBjb25zdCBuZXh0ID0gZm4ocHJldilcbiAgICBpZiAobG9jaykge1xuICAgICAgaWYgKCFhdG9tcy5maW5kKHggPT4geCA9PT0gdGhpcykpIHtcbiAgICAgICAgcHJldnMucHVzaChwcmV2KVxuICAgICAgICBhdG9tcy5wdXNoKHRoaXMpXG4gICAgICB9XG4gICAgICBjdXJyZW50LnZhbHVlID0gbmV4dFxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl9tYXliZUVtaXRWYWx1ZShuZXh0KVxuICAgIH1cbiAgfVxufVxuXG4vL1xuXG5jb25zdCBjb25zdHJ1Y3Rvck9mID0geCA9PiB4ICYmIHguY29uc3RydWN0b3JcblxuZnVuY3Rpb24gZ2V0TXV0YWJsZXModGVtcGxhdGUsIG11dGFibGVzID0gW10pIHtcbiAgaWYgKHRlbXBsYXRlIGluc3RhbmNlb2YgQWJzdHJhY3RNdXRhYmxlICYmXG4gICAgICAhbXV0YWJsZXMuZmluZChtID0+IG0gPT09IHRlbXBsYXRlKSkge1xuICAgIG11dGFibGVzLnB1c2godGVtcGxhdGUpXG4gIH0gZWxzZSB7XG4gICAgY29uc3QgY29uc3RydWN0b3IgPSBjb25zdHJ1Y3Rvck9mKHRlbXBsYXRlKVxuXG4gICAgaWYgKGNvbnN0cnVjdG9yID09PSBBcnJheSlcbiAgICAgIGZvciAobGV0IGk9MCwgbj10ZW1wbGF0ZS5sZW5ndGg7IGk8bjsgKytpKVxuICAgICAgICBnZXRNdXRhYmxlcyh0ZW1wbGF0ZVtpXSwgbXV0YWJsZXMpXG4gICAgZWxzZSBpZiAoY29uc3RydWN0b3IgPT09IE9iamVjdClcbiAgICAgIGZvciAoY29uc3QgayBpbiB0ZW1wbGF0ZSlcbiAgICAgICAgZ2V0TXV0YWJsZXModGVtcGxhdGVba10sIG11dGFibGVzKVxuICB9XG4gIHJldHVybiBtdXRhYmxlc1xufVxuXG5mdW5jdGlvbiBjb21iaW5lKHRlbXBsYXRlKSB7XG4gIGlmICh0ZW1wbGF0ZSBpbnN0YW5jZW9mIEFic3RyYWN0TXV0YWJsZSkge1xuICAgIHJldHVybiB0ZW1wbGF0ZS5nZXQoKVxuICB9IGVsc2Uge1xuICAgIGNvbnN0IGNvbnN0cnVjdG9yID0gY29uc3RydWN0b3JPZih0ZW1wbGF0ZSlcblxuICAgIGlmIChjb25zdHJ1Y3RvciA9PT0gQXJyYXkpIHtcbiAgICAgIGNvbnN0IG4gPSB0ZW1wbGF0ZS5sZW5ndGhcbiAgICAgIGNvbnN0IG5leHQgPSBBcnJheShuKVxuICAgICAgZm9yIChsZXQgaT0wOyBpPG47ICsraSlcbiAgICAgICAgbmV4dFtpXSA9IGNvbWJpbmUodGVtcGxhdGVbaV0pXG4gICAgICByZXR1cm4gbmV4dFxuICAgIH0gZWxzZSBpZiAoY29uc3RydWN0b3IgPT09IE9iamVjdCkge1xuICAgICAgY29uc3QgbmV4dCA9IHt9XG4gICAgICBmb3IgKGNvbnN0IGsgaW4gdGVtcGxhdGUpXG4gICAgICAgIG5leHRba10gPSBjb21iaW5lKHRlbXBsYXRlW2tdKVxuICAgICAgcmV0dXJuIG5leHRcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHRlbXBsYXRlXG4gICAgfVxuICB9XG59XG5cbmNvbnN0IG1pc21hdGNoID0gKCkgPT4ge3Rocm93IG5ldyBFcnJvcihcIk1vbGVjdWxlIGNhbm5vdCBjaGFuZ2UgdGhlIHRlbXBsYXRlLlwiKX1cblxuZnVuY3Rpb24gc2V0TXV0YWJsZXModGVtcGxhdGUsIHZhbHVlKSB7XG4gIGlmICh0ZW1wbGF0ZSBpbnN0YW5jZW9mIEFic3RyYWN0TXV0YWJsZSkge1xuICAgIHJldHVybiB0ZW1wbGF0ZS5zZXQodmFsdWUpXG4gIH0gZWxzZSB7XG4gICAgY29uc3QgY29uc3RydWN0b3IgPSBjb25zdHJ1Y3Rvck9mKHRlbXBsYXRlKVxuXG4gICAgaWYgKGNvbnN0cnVjdG9yICE9PSBjb25zdHJ1Y3Rvck9mKHZhbHVlKSlcbiAgICAgIG1pc21hdGNoKClcblxuICAgIGlmIChjb25zdHJ1Y3RvciA9PT0gQXJyYXkpXG4gICAgICBmb3IgKGxldCBpPTAsIG49dGVtcGxhdGUubGVuZ3RoOyBpPG47ICsraSlcbiAgICAgICAgc2V0TXV0YWJsZXModGVtcGxhdGVbaV0sIHZhbHVlW2ldKVxuICAgIGVsc2UgaWYgKGNvbnN0cnVjdG9yID09PSBPYmplY3QpXG4gICAgICBmb3IgKGNvbnN0IGsgaW4gdGVtcGxhdGUpXG4gICAgICAgIHNldE11dGFibGVzKHRlbXBsYXRlW2tdLCB2YWx1ZVtrXSlcbiAgICBlbHNlIGlmICghUi5lcXVhbHModGVtcGxhdGUsIHZhbHVlKSlcbiAgICAgIG1pc21hdGNoKClcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgTW9sZWN1bGUgZXh0ZW5kcyBNdXRhYmxlV2l0aFNvdXJjZSB7XG4gIGNvbnN0cnVjdG9yKHRlbXBsYXRlKSB7XG4gICAgc3VwZXIoS2VmaXIuY29tYmluZShnZXRNdXRhYmxlcyh0ZW1wbGF0ZSkpKVxuICAgIHRoaXMuX3RlbXBsYXRlID0gdGVtcGxhdGVcbiAgfVxuICBfZ2V0RnJvbVNvdXJjZSgpIHtcbiAgICByZXR1cm4gY29tYmluZSh0aGlzLl90ZW1wbGF0ZSlcbiAgfVxuICBtb2RpZnkoZm4pIHtcbiAgICBjb25zdCBuZXh0ID0gZm4odGhpcy5nZXQoKSlcbiAgICBob2xkaW5nKCgpID0+IHNldE11dGFibGVzKHRoaXMuX3RlbXBsYXRlLCBuZXh0KSlcbiAgfVxufVxuXG4vL1xuXG5leHBvcnQgZGVmYXVsdCB2YWx1ZSA9PiBuZXcgQXRvbSh2YWx1ZSlcbiJdfQ==